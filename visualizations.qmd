---
title: "Ø§Ù„ØªØµÙˆØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©"
subtitle: "Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù†Ø³Ø¨ Ø§Ù„Ù†Ø¬Ø§Ø­"
---

```{r}
#| label: setup
#| include: false

.libPaths(Sys.getenv("R_LIBS_USER"))
library(tidyverse)
library(knitr)
library(kableExtra)
library(scales)

source("R/load_data.R")
source("R/bac_data.R")
```

##  Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­ {.unnumbered}

```{r}
#| label: fig-overview
#| fig-cap: "Ù†Ø³Ø¨ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©"
#| fig-width: 14
#| fig-height: 10

gov_stats <- school_data %>%
  filter(!is.na(governorate_ar)) %>%
  group_by(governorate_ar) %>%
  summarise(
    students = sum(nb_students),
    passed = sum(nb_passed),
    success_rate = round(passed / students * 100, 1),
    .groups = "drop"
  ) %>%
  arrange(desc(success_rate))

ggplot(gov_stats, aes(x = reorder(governorate_ar, success_rate), y = success_rate)) +
  geom_segment(aes(xend = governorate_ar, yend = 0), color = "#3498db", linewidth = 3, alpha = 0.5) +
  geom_point(aes(color = success_rate, size = students), show.legend = TRUE) +
  geom_text(aes(label = paste0(success_rate, "%")), hjust = -0.3, size = 4, fontface = "bold") +
  scale_color_gradient2(low = "#e74c3c", mid = "#f39c12", high = "#27ae60", midpoint = 90, name = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­") +
  scale_size_continuous(range = c(4, 15), name = "Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ„Ø§Ù…ÙŠØ°", labels = comma) +
  coord_flip() +
  ylim(0, 100) +
  labs(
    title = "ğŸ—ºï¸ Ù†Ø³Ø¨ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
    subtitle = "ØªØ±ØªÙŠØ¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù†Ù‰",
    x = "",
    y = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 22, color = "#2c3e50"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, color = "#7f8c8d"),
    axis.text.y = element_text(size = 12, face = "bold"),
    legend.position = "right"
  )
```

---

## ğŸ“ Ø§Ù„Ù…Ø³ÙŠØ±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© {.unnumbered}

```{r}
#| label: fig-journey
#| fig-cap: "Ù†Ø³Ø¨ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©"
#| fig-width: 14
#| fig-height: 8

year_analysis <- school_data %>%
  mutate(
    year_order = case_when(
      str_detect(level_name, "Ø³Ø§Ø¨Ø¹Ø©") ~ 1,
      str_detect(level_name, "Ø«Ø§Ù…Ù†Ø©") ~ 2,
      str_detect(level_name, "ØªØ§Ø³Ø¹Ø©") ~ 3,
      str_detect(level_name, "Ø£ÙˆÙ„Ù‰") ~ 4,
      str_detect(level_name, "Ø«Ø§Ù†ÙŠØ©") ~ 5,
      str_detect(level_name, "Ø«Ø§Ù„Ø«Ø©") ~ 6,
      TRUE ~ 0
    ),
    year_label = case_when(
      str_detect(level_name, "Ø³Ø§Ø¨Ø¹Ø©") ~ "Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©\nØ£Ø³Ø§Ø³ÙŠ",
      str_detect(level_name, "Ø«Ø§Ù…Ù†Ø©") ~ "Ø§Ù„Ø«Ø§Ù…Ù†Ø©\nØ£Ø³Ø§Ø³ÙŠ",
      str_detect(level_name, "ØªØ§Ø³Ø¹Ø©") ~ "Ø§Ù„ØªØ§Ø³Ø¹Ø©\nØ£Ø³Ø§Ø³ÙŠ",
      str_detect(level_name, "Ø£ÙˆÙ„Ù‰") ~ "Ø§Ù„Ø£ÙˆÙ„Ù‰\nØ«Ø§Ù†ÙˆÙŠ",
      str_detect(level_name, "Ø«Ø§Ù†ÙŠØ©") ~ "Ø§Ù„Ø«Ø§Ù†ÙŠØ©\nØ«Ø§Ù†ÙˆÙŠ",
      str_detect(level_name, "Ø«Ø§Ù„Ø«Ø©") ~ "Ø§Ù„Ø«Ø§Ù„Ø«Ø©\nØ«Ø§Ù†ÙˆÙŠ",
      TRUE ~ "Ø£Ø®Ø±Ù‰"
    )
  ) %>%
  filter(year_order > 0) %>%
  group_by(year_order, year_label) %>%
  summarise(
    students = sum(nb_students),
    passed = sum(nb_passed),
    success_rate = round(passed / students * 100, 1),
    .groups = "drop"
  )

ggplot(year_analysis, aes(x = year_order, y = success_rate)) +
  geom_area(fill = "#3498db", alpha = 0.3) +
  geom_line(color = "#2c3e50", linewidth = 2) +
  geom_point(aes(size = students), color = "#e74c3c") +
  geom_text(aes(label = paste0(success_rate, "%")), vjust = -1.5, size = 6, fontface = "bold") +
  scale_x_continuous(breaks = year_analysis$year_order, labels = year_analysis$year_label) +
  scale_size_continuous(range = c(8, 18), guide = "none") +
  labs(
    title = " Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§",
    subtitle = "ØªØªØ¨Ø¹ Ù†Ø³Ø¨ Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ù† Ø§Ù„Ø³Ø§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ",
    x = "Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©",
    y = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)"
  ) +
  ylim(70, 100) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 22, color = "#2c3e50"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, color = "#7f8c8d"),
    axis.text.x = element_text(size = 11, face = "bold")
  )
```

---

##  Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø© {.unnumbered}

```{r}
#| label: fig-bac-field
#| fig-cap: "Ù†Ø³Ø¨ Ù†Ø¬Ø§Ø­ Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©"
#| fig-width: 14
#| fig-height: 10

ggplot(bac_by_field, aes(x = reorder(field_ar, bac_success_rate), y = bac_success_rate)) +
  geom_col(aes(fill = bac_success_rate), width = 0.75, show.legend = FALSE) +
  geom_text(aes(label = paste0(bac_success_rate, "%")), hjust = -0.1, size = 6, fontface = "bold") +
  geom_hline(yintercept = 50, linetype = "dashed", color = "#e74c3c", linewidth = 1.2) +
  annotate("text", x = 4, y = 52, label = "â† Ø¹ØªØ¨Ø© 50%", color = "#e74c3c", fontface = "bold", size = 5) +
  scale_fill_gradient2(low = "#c0392b", mid = "#f39c12", high = "#27ae60", midpoint = 50) +
  coord_flip() +
  ylim(0, 85) +
  labs(
    title = " Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 - Ø§Ù„Ù†Ø¬Ø§Ø­ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©",
    subtitle = "Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠØ©: Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©",
    x = "",
    y = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)",
    caption = "Ø§Ù„Ù…ØµØ¯Ø±: ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ©ØŒ ØªÙˆÙ†Ø³"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 24, color = "#2c3e50"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, color = "#7f8c8d"),
    axis.text.y = element_text(size = 14, face = "bold")
  )
```

---

## ğŸ—ºï¸ Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© {.unnumbered}

```{r}
#| label: fig-bac-gov
#| fig-cap: "Ù†Ø³Ø¨ Ù†Ø¬Ø§Ø­ Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©"
#| fig-width: 14
#| fig-height: 14

ggplot(bac_by_governorate, aes(x = reorder(governorate_ar, bac_success_rate), y = bac_success_rate)) +
  geom_segment(aes(xend = governorate_ar, yend = 40), color = "gray80", linewidth = 1) +
  geom_point(aes(color = bac_success_rate, size = candidates), show.legend = TRUE) +
  geom_text(aes(label = paste0(bac_success_rate, "%")), hjust = -0.3, size = 4, fontface = "bold") +
  scale_color_gradient2(low = "#c0392b", mid = "#f39c12", high = "#27ae60", midpoint = 55, name = "Ù†Ø³Ø¨Ø©\nØ§Ù„Ù†Ø¬Ø§Ø­") +
  scale_size_continuous(range = c(4, 12), name = "Ø§Ù„Ù…ØªØ±Ø´Ø­ÙˆÙ†", labels = comma) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "#e74c3c", linewidth = 1) +
  coord_flip() +
  ylim(40, 78) +
  labs(
    title = " Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 - Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ù‡ÙˆÙŠ",
    subtitle = "ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠØ§Øª Ø§Ù„Ø¬Ù‡ÙˆÙŠØ© Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­",
    x = "",
    y = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)",
    caption = "Ø§Ù„Ù…ØµØ¯Ø±: ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© - Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 22, color = "#2c3e50"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, color = "#7f8c8d"),
    axis.text.y = element_text(size = 11, face = "bold"),
    legend.position = "right"
  )
```

---

## ğŸ’” Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© {.unnumbered}

```{r}
#| label: fig-gap
#| fig-cap: "Ø§Ù„ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§"
#| fig-width: 14
#| fig-height: 10

comparison_data <- tibble(
  field = c(" Ø§Ù„Ø¢Ø¯Ø§Ø¨", " Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯", " Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØªÙ‚Ù†ÙŠØ©", " Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©", 
            " Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©", " Ø§Ù„Ø±ÙŠØ§Ø¶Ø©", " Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª"),
  prebac_estimate = c(90.5, 85.4, 88.2, 92.5, 94.1, 97.8, 97.2),
  bac_actual = c(23.02, 28.95, 35.02, 45.83, 48.47, 73.33, 74.93)
) %>%
  mutate(gap = prebac_estimate - bac_actual)

comparison_long <- comparison_data %>%
  pivot_longer(cols = c(prebac_estimate, bac_actual), 
               names_to = "exam_type", values_to = "success_rate") %>%
  mutate(exam_label = if_else(exam_type == "prebac_estimate", " Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø§Ùƒ (Ø§Ù„Ù…Ø¯Ø±Ø³Ø©)", " Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025"))

ggplot(comparison_long, aes(x = reorder(field, success_rate), y = success_rate, fill = exam_label)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = paste0(success_rate, "%")), 
            position = position_dodge(width = 0.7), hjust = -0.1, size = 4, fontface = "bold") +
  scale_fill_manual(values = c(" Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø§Ùƒ (Ø§Ù„Ù…Ø¯Ø±Ø³Ø©)" = "#27ae60", " Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025" = "#c0392b"), name = "Ù†ÙˆØ¹ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†") +
  coord_flip() +
  ylim(0, 110) +
  labs(
    title = " Ø§Ù„ÙØ¬ÙˆØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©",
    subtitle = "Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025",
    x = "",
    y = "Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 24, color = "#c0392b"),
    plot.subtitle = element_text(hjust = 0.5, size = 14, color = "#7f8c8d"),
    axis.text.y = element_text(size = 13, face = "bold"),
    legend.position = "bottom"
  )
```

---

##  Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¬ÙˆØ© {.unnumbered}

```{r}
#| label: gap-table

comparison_data %>%
  arrange(desc(gap)) %>%
  mutate(
    prebac_estimate = paste0(prebac_estimate, "%"),
    bac_actual = paste0(bac_actual, "%"),
    gap = paste0("ğŸ”» -", round(gap, 1), " Ù†Ù‚Ø·Ø©")
  ) %>%
  kable(col.names = c("Ø§Ù„Ø´Ø¹Ø¨Ø©", "Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø§Ùƒ %", "Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ 2025 %", "Ø§Ù„ÙØ¬ÙˆØ©"),
        caption = "Ø§Ù„Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ø­Ø§Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ Ø¥Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(4, color = "#c0392b", bold = TRUE)
```
